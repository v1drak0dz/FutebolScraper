CREATE OR REPLACE VIEW classificacao AS
SELECT
    t.id AS time_id,
    t.nome AS time,
    l.id AS campeonato_id,
    l.nome AS campeonato,
    t.grupo,

    -- Total de jogos finalizados
    COUNT(p.id) AS jogos,

    -- VitÃ³rias
    SUM(
        CASE 
            WHEN t.id = p.time_casa_id AND p.gols_casa > p.gols_fora THEN 1
            WHEN t.id = p.time_fora_id AND p.gols_fora > p.gols_casa THEN 1
            ELSE 0
        END
    ) AS vitorias,

    -- Empates
    SUM(
        CASE
            WHEN p.gols_casa = p.gols_fora THEN 1
            ELSE 0
        END
    ) AS empates,

    -- Derrotas
    SUM(
        CASE
            WHEN t.id = p.time_casa_id AND p.gols_casa < p.gols_fora THEN 1
            WHEN t.id = p.time_fora_id AND p.gols_fora < p.gols_casa THEN 1
            ELSE 0
        END
    ) AS derrotas,

    -- Gols a favor
    SUM(
        CASE
            WHEN t.id = p.time_casa_id THEN p.gols_casa
            WHEN t.id = p.time_fora_id THEN p.gols_fora
            ELSE 0
        END
    ) AS gols_pro,

    -- Gols contra
    SUM(
        CASE
            WHEN t.id = p.time_casa_id THEN p.gols_fora
            WHEN t.id = p.time_fora_id THEN p.gols_casa
            ELSE 0
        END
    ) AS gols_contra,

    -- Saldo de gols
    SUM(
        CASE
            WHEN t.id = p.time_casa_id THEN p.gols_casa - p.gols_fora
            WHEN t.id = p.time_fora_id THEN p.gols_fora - p.gols_casa
            ELSE 0
        END
    ) AS saldo_gols,

    -- Pontos
    SUM(
        CASE
            WHEN t.id = p.time_casa_id AND p.gols_casa > p.gols_fora THEN 3
            WHEN t.id = p.time_fora_id AND p.gols_fora > p.gols_casa THEN 3
            WHEN p.gols_casa = p.gols_fora THEN 1
            ELSE 0
        END
    ) AS pontos

FROM times t
JOIN ligas l ON t.campeonato_id = l.id
LEFT JOIN partidas p 
    ON (t.id = p.time_casa_id OR t.id = p.time_fora_id)
    AND p.finalizada = 1 -- apenas partidas finalizadas
GROUP BY t.id, t.nome, l.id, l.nome, t.grupo
;
